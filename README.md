# Telegram отчетный бот (aiogram 3)

Бот отслеживает, кто отправил отчет в тему (topic) "Отчеты" и в момент дедлайна присылает список отчитавшихся и неотчитавшихся.

## Возможности

- фиксирует сообщения в нужной теме (topic) группы;
- хранит отчеты по дням в SQLite;
- в дедлайн публикует список отчитавшихся/неотчитавшихся;
- команда `/reportstatus` показывает текущий статус по дню.

## Быстрый старт

1. Установите зависимости:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2. Создайте файл `.env` рядом с `main.py`:

```env
BOT_TOKEN=123456:ABCDEF
TIMEZONE=Europe/Moscow
SETTINGS_PATH=settings.json
REQUIRED_USER_IDS=11111111,22222222,33333333
# Если не хотите использовать settings.json -> chats, можно задать один чат:
# CHAT_ID=-1001234567890
# REPORT_THREAD_ID=12345
```

- `SETTINGS_PATH` — путь к файлу настроек (ниже пример).
- `REQUIRED_USER_IDS` — запасной список участников, если не заполнять файл настроек.
- `CHAT_ID` / `REPORT_THREAD_ID` — опциональная пара для одного чата, если не используется `chats` в settings.json.

3. Создайте `settings.json` рядом с `main.py` для удобной правки дедлайнов и списка людей:

```json
{
  "chats": [
    {
      "chat_id": -1001234567890,
      "report_thread_id": 12345,
      "required_users": [
        {"id": 11111111, "name": "Иван Петров", "username": "ivanpetrov"},
        {"id": 22222222, "name": "Ольга", "username": "olga"}
      ]
    },
    {
      "chat_id": -1009999999999,
      "report_thread_id": 67890,
      "required_users": [
        {"id": 33333333, "name": "Анна", "username": "anna"}
      ]
    }
  ],
  "deadlines": [
    {
      "key": "morning",
      "title": "Утренний отчет",
      "tag": "#УтреннийОтчет",
      "weekday_time": "11:00",
      "weekend_time": "12:00"
    },
    {
      "key": "evening",
      "title": "Вечерний отчет",
      "tag": "#ВечернийОтчет",
      "weekday_time": "18:00",
      "weekend_time": "19:00"
    }
  ]
}
```

- `tag` — хештег, который должны указывать люди в отчете.
- `weekday_time` / `weekend_time` — разное время для будней и выходных.
- `chats` — список чатов с их `chat_id`, `report_thread_id` и списком обязанных пользователей.
  Если нужно отслеживать несколько топиков в одном чате, добавьте несколько записей
  с одинаковым `chat_id`, но разным `report_thread_id`.
  Команду `/reportstatus` нужно запускать в том же топике, по которому нужен статус.

4. Запуск:

```bash
python main.py
```

## Как узнать ID темы

Включите режим администратора в боте @RawDataBot или @getidsbot и отправьте сообщение в нужную тему — в ответе будет `message_thread_id`.

## Важно

Telegram не дает боту полный список участников группы, поэтому список обязанных пользователей задается через `REQUIRED_USER_IDS`.

Если вы обновляете уже существующую базу `data.db`, бот сам мигрирует схему (добавит недостающие колонки и ключи). В редких случаях проще удалить старый `data.db`, чтобы он создался заново.
